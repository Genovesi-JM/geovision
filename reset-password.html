<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Redefinir palavra-passe – GeoVision</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    body { background: radial-gradient(circle at top, #132237, #060b13 60%); color:#f5f5f5; font-family: "Inter", system-ui, Arial, sans-serif; margin:0; padding:0; }
    .box { max-width:520px;margin:6vh auto;padding:2.4rem;background:rgba(255,255,255,0.04);border-radius:14px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 16px 48px rgba(0,0,0,0.35); }
    h1 { margin:0 0 0.6rem; }
    .muted { color:#cdd5e1;font-size:0.95rem;margin:0 0 1rem; }
    label { display:block;margin-top:0.8rem;font-weight:600; }
    input { width:100%;padding:0.85rem;border-radius:10px;border:1px solid rgba(255,255,255,0.14);background:rgba(255,255,255,0.07);color:#fff; }
    input:focus { outline:none;border-color:#38bdf8;box-shadow:0 0 0 3px rgba(56,189,248,0.25); }
    .btn { margin-top:1rem;padding:0.9rem;border-radius:10px;border:none;background:linear-gradient(135deg,#22c55e,#38bdf8);color:#052010;font-weight:700;width:100%;cursor:pointer; }
    .feedback { margin-top:0.9rem;font-size:0.95rem; }
    .error { color:#ff9b9b; }
    .success { color:#b6f4c5; }
    a { color:#8ed0ff; }
  </style>
</head>
<body>
  <div class="box">
    <h1>Redefinir palavra-passe</h1>
    <p class="muted">Se abriste este link a partir do email, o token já deve vir na URL. Caso contrário, cola-o abaixo.</p>

    <label for="token">Token</label>
    <input id="token" placeholder="Cole aqui o token da URL" autocomplete="one-time-code" />

    <label for="pass">Nova password</label>
    <input id="pass" type="password" placeholder="Nova password" autocomplete="new-password" />

    <label for="pass2">Confirmar password</label>
    <input id="pass2" type="password" placeholder="Confirmar password" autocomplete="new-password" />

    <button id="submit" class="btn">Definir nova password</button>

    <div id="out" class="feedback"></div>

    <p style="margin-top:1.2rem"><a href="login.html">← Voltar ao login</a></p>
  </div>

  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const tokenInput = document.getElementById('token');
      if (params.has('token')) tokenInput.value = params.get('token');

      const out = document.getElementById('out');
      function show(msg, ok=false){
        out.textContent = msg;
        out.className = 'feedback ' + (ok ? 'success' : 'error');
      }

      document.getElementById('submit').addEventListener('click', async function(){
        const token = (tokenInput.value || '').trim();
        const p1 = (document.getElementById('pass').value || '').trim();
        const p2 = (document.getElementById('pass2').value || '').trim();
        out.textContent = '';
        if (!token) return show('Token ausente.');
        if (!p1) return show('Insere a nova password.');
        if (p1 !== p2) return show('As passwords não coincidem.');

        try {
          const API_BASE = window.API_BASE || 'http://127.0.0.1:8010';
          const res = await fetch(API_BASE + '/auth/reset-password', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ token: token, new_password: p1 })
          });
          const text = await res.text();
          if (!res.ok) throw new Error(text || res.statusText || res.status);
          show(text || 'Password alterada com sucesso.', true);
        } catch (err) {
          console.error(err);
          show(err && err.message ? err.message : 'Erro ao redefinir password.');
        }
      });
    })();
  </script>
</body>
</html>
